<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æç®€ä»£ç é¢„è§ˆå™¨</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;}
        html,body{height:100%;}
        body{display:flex;flex-direction:column;background:#111;color:#eee;font-family:monospace;}

        /* ç¼–è¾‘æ€ */
        .edit .toolbar{
            display:flex;align-items:center;justify-content:space-between;
            padding:.5rem .75rem;background:#222;border-bottom:1px solid #444;flex-shrink:0;
        }
        .edit .btn{
            background:#444;color:#eee;border:none;padding:.4rem .8rem;border-radius:4px;font-size:.9rem;cursor:pointer;
        }
        .edit .btn:hover{background:#555;}
        .edit .btn.active{background:#0969da;color:#fff;}
        .edit .main{flex:1;display:flex;min-height:0;}
        .edit .codeWrap{flex:1;display:flex;flex-direction:column;border-right:1px solid #444;}
        .edit textarea{
            flex:1;width:100%;height:100%;background:#0d1117;color:#c9d1d9;border:none;
            padding:1rem;resize:none;outline:none;font-family:monospace;font-size:14px;line-height:1.5;
        }
        .edit .previewWrap{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;background:#333;}
        .edit iframe{
            width:100%;height:100%;background:#fff;border:none;
        }
        /* ç§»åŠ¨ç«¯é¢„è§ˆæ¨¡å¼ */
        .edit .previewWrap.mobile{
            background:#1a1a1a;
        }
        .edit .previewWrap.mobile iframe{
            width:375px;
            height:667px;
            border:8px solid #222;
            border-radius:20px;
            box-shadow:0 10px 40px rgba(0,0,0,0.5);
        }

        /* PCç«¯å…¨å±é¢„è§ˆæ€ */
        .previewOnly iframe{
            position:fixed;inset:0;width:100vw;height:100vh;border:none;background:#fff;
        }
        .previewOnly .toolbar,.previewOnly .codeWrap{display:none;}

        /* æç¤ºæ¡ */
        #tip{
            position:fixed;bottom:1rem;left:50%;transform:translateX(-50%);
            background:rgba(0,0,0,.7);color:#fff;padding:.4rem .8rem;border-radius:4px;font-size:.8rem;
            opacity:0;transition:opacity .3s;pointer-events:none;
        }
        #tip.show{opacity:1;}
    </style>
</head>
<body class="edit">
    <div class="toolbar">
        <span>ä»£ç  â†’ é¢„è§ˆ</span>
        <div>
            <button class="btn active" id="pcBtn">ğŸ’» PC</button>
            <button class="btn" id="mobileBtn">ğŸ“± ç§»åŠ¨</button>
            <button class="btn" id="runBtn">é¢„è§ˆ</button>
            <button class="btn" id="clearBtn">æ¸…ç©º</button>
            <button class="btn" id="downloadBtn">ä¸‹è½½</button>
        </div>
    </div>

    <div class="main">
        <div class="codeWrap">
            <textarea id="code" placeholder="è¾“å…¥ HTML/CSS/JS åç‚¹ã€Œé¢„è§ˆã€"></textarea>
        </div>
        <div class="previewWrap" id="previewWrap">
            <iframe id="preview" src="about:blank"></iframe>
        </div>
    </div>

    <div id="tip"></div>

    <script>
        const d=document;
        const $=q=>d.querySelector(q);
        const code=$('#code'), iframe=$('#preview'), tip=$('#tip'), run=$('#runBtn'), clear=$('#clearBtn'), downloadBtn=$('#downloadBtn');
        const pcBtn=$('#pcBtn'), mobileBtn=$('#mobileBtn'), previewWrap=$('#previewWrap');
        
        let viewMode = 'pc'; // é»˜è®¤PCç«¯
        const STORAGE_KEY = 'code-preview-cache';
        let saveTimer = null;

        // æ£€æµ‹æ˜¯å¦ä¸ºç§»åŠ¨è®¾å¤‡
        const isMobileDevice = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) 
                            || window.innerWidth <= 768;

        // åŠ è½½ç¼“å­˜çš„ä»£ç 
        function loadCache() {
            try {
                const cached = localStorage.getItem(STORAGE_KEY);
                if (cached) {
                    code.value = cached;
                    showTip('å·²æ¢å¤ä¸Šæ¬¡çš„ä»£ç ');
                }
            } catch (e) {
                console.error('åŠ è½½ç¼“å­˜å¤±è´¥:', e);
            }
        }

        // ä¿å­˜ä»£ç åˆ°ç¼“å­˜ï¼ˆé˜²æŠ–ï¼‰
        function saveCache() {
            clearTimeout(saveTimer);
            saveTimer = setTimeout(() => {
                try {
                    localStorage.setItem(STORAGE_KEY, code.value);
                } catch (e) {
                    console.error('ä¿å­˜ç¼“å­˜å¤±è´¥:', e);
                }
            }, 500); // 500msé˜²æŠ–
        }

        // ç›‘å¬ä»£ç è¾“å…¥ï¼Œè‡ªåŠ¨ä¿å­˜
        code.addEventListener('input', saveCache);

        function showTip(txt){
            tip.textContent=txt;
            tip.classList.add('show');
            setTimeout(()=>tip.classList.remove('show'),1500);
        }

        function switchViewMode(mode) {
            viewMode = mode;
            if (mode === 'mobile') {
                previewWrap.classList.add('mobile');
                mobileBtn.classList.add('active');
                pcBtn.classList.remove('active');
                showTip('åˆ‡æ¢åˆ°ç§»åŠ¨ç«¯é¢„è§ˆ (375x667)');
            } else {
                previewWrap.classList.remove('mobile');
                pcBtn.classList.add('active');
                mobileBtn.classList.remove('active');
                showTip('åˆ‡æ¢åˆ°PCç«¯é¢„è§ˆ');
            }
            // å¦‚æœå·²ç»æœ‰é¢„è§ˆå†…å®¹ï¼Œé‡æ–°æ¸²æŸ“
            if (iframe.contentDocument.body && iframe.contentDocument.body.innerHTML) {
                runCode();
            }
        }

        function runCode(){
            const html=code.value.trim();
            if(!html) return showTip('ä»£ç ä¸ºç©º');
            const doc=iframe.contentDocument;
            doc.open();
            doc.write(html);
            doc.close();
            
            // PCç«¯ï¼šå…¨å±é¢„è§ˆï¼ˆéšè—ç¼–è¾‘åŒºï¼‰
            // ç§»åŠ¨ç«¯æ¨¡å¼ï¼š
            //   - å¦‚æœæ˜¯ç§»åŠ¨è®¾å¤‡è®¿é—®ï¼šå…¨å±é¢„è§ˆï¼ˆæ–¹ä¾¿æµ‹è¯•ï¼‰
            //   - å¦‚æœæ˜¯PCè®¾å¤‡è®¿é—®ï¼šä¿æŒåˆ†å±æ˜¾ç¤º
            if (viewMode === 'pc' || (viewMode === 'mobile' && isMobileDevice)) {
                d.body.className='previewOnly';
                showTip('åŒå‡»å±å¹•è¿”å›ç¼–è¾‘');
            } else {
                showTip('é¢„è§ˆå·²æ›´æ–°');
            }
        }

        function backToEdit(){
            d.body.className='edit';
            showTip('å·²è¿”å›ç¼–è¾‘');
        }

        function downloadHTML() {
            const src = code.value.trim();
            if (!src) return showTip('ä»£ç ä¸ºç©º');
            let fileName = prompt('è¯·è¾“å…¥æ–‡ä»¶åï¼ˆå« .html åç¼€ï¼‰', 'index.html');
            if (!fileName) return;
            if (!fileName.endsWith('.html')) fileName += '.html';
            const standalone = `<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>${fileName.replace('.html', '')}</title>
  <style>body{margin:40px;font-family:system-ui;background:#fff;color:#222;}</style>
</head>
<body>
${src}
</body>
</html>`;
            const blob = new Blob([standalone], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            a.click();
            URL.revokeObjectURL(url);
            showTip('å·²ä¸‹è½½ ' + fileName);
        }

        function clearCode() {
            if(confirm('æ¸…ç©ºä»£ç ï¼Ÿç¼“å­˜ä¹Ÿä¼šè¢«æ¸…é™¤')) {
                code.value='';
                localStorage.removeItem(STORAGE_KEY);
                showTip('å·²æ¸…ç©º');
            }
        }

        pcBtn.onclick=()=>switchViewMode('pc');
        mobileBtn.onclick=()=>switchViewMode('mobile');
        run.onclick=runCode;
        clear.onclick=clearCode;
        downloadBtn.onclick=downloadHTML;
        d.addEventListener('dblclick',backToEdit);
        d.addEventListener('touchend',(e)=>{
            const t=Date.now();
            if(t-(d._last||0)<300) backToEdit();
            d._last=t;
        });

        // é¡µé¢åŠ è½½æ—¶æ¢å¤ç¼“å­˜
        window.onload=()=>{
            loadCache();
            if (!code.value) {
                const deviceTip = isMobileDevice ? 'ï¼ˆå·²æ£€æµ‹åˆ°ç§»åŠ¨è®¾å¤‡ï¼‰' : '';
                showTip('è¾“å…¥ä»£ç åç‚¹ã€Œé¢„è§ˆã€æŸ¥çœ‹æ•ˆæœ' + deviceTip);
            }
        };
    </script>
</body>
</html>
