<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI å°è¯´åˆ›ä½œå° - v6.21 ç»Ÿä¸€UIç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* --- åŸºç¡€æ’ç‰ˆ --- */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
            background-color: #F9FAFB; 
            color: #1F2937;
            overflow: hidden; 
            -webkit-font-smoothing: antialiased;
        }
        
        /* ä¼˜é›…çš„ç»†æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #E5E7EB; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #D1D5DB; }

        /* å¸ƒå±€æ¡†æ¶ */
        #app-container { display: flex; height: 100vh; width: 100vw; }
        
        /* --- ä¾§è¾¹æ ï¼šæ·±è‰²æç®€ --- */
        #sidebar { 
            width: 260px; 
            background: #111827; 
            color: #9CA3AF; 
            flex-shrink: 0; 
            display: flex; 
            flex-direction: column; 
            border-right: 1px solid #1F2937;
        }
        .sidebar-header { 
            padding: 24px; 
            font-size: 15px; 
            font-weight: 600; 
            color: #F3F4F6; 
            display: flex; justify-content: space-between; align-items: center;
            letter-spacing: 0.02em;
        }
        .sidebar-item { 
            padding: 10px 16px; 
            cursor: pointer; 
            border-radius: 8px; 
            margin: 2px 12px; 
            transition: all 0.15s ease; 
            display: flex; align-items: center; 
            font-size: 13px; 
            font-weight: 500;
        }
        .sidebar-item:hover { background: rgba(255,255,255,0.05); color: #F3F4F6; }
        .sidebar-item.active { background: #F97316; color: white; box-shadow: 0 4px 12px rgba(249, 115, 22, 0.3); }
        .sidebar-item.active i { color: white !important; }
        
        /* --- ä¸»èˆå° --- */
        #main-stage { flex: 1; position: relative; overflow: hidden; background: #F9FAFB; display: flex; flex-direction: column; }
        .page-view { display: none; width: 100%; height: 100%; flex-direction: column; overflow-y: auto; }
        .page-view.active { display: flex; animation: fadeIn 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- é€šç”¨ç»„ä»¶è®¾è®¡ (Form & Card) --- */
        .card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 24px; padding: 40px; }
        
        /* æ‹Ÿæ€/æ‰å¹³åŒ–è¾“å…¥æ¡† */
        .design-input-group { margin-bottom: 24px; }
        .design-label { 
            font-size: 12px; font-weight: 700; color: #6B7280; 
            text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 8px; 
            display: flex; justify-content: space-between; align-items: center;
        }
        .design-input {
            width: 100%; background: transparent;
            border-bottom: 2px solid #E5E7EB;
            padding: 8px 0; font-size: 15px; color: #111827;
            outline: none; transition: all 0.3s;
        }
        .design-input:focus { border-color: #F97316; }
        .design-textarea {
            width: 100%; background: #F3F4F6;
            border: 1px solid transparent; border-radius: 12px;
            padding: 16px; font-size: 14px; color: #374151;
            outline: none; resize: none; transition: all 0.2s;
        }
        .design-textarea:focus { background: white; border-color: #D1D5DB; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }

        /* æ ‡ç­¾é€‰æ‹©å™¨ */
        .tag-radio-label {
            font-size: 13px; padding: 6px 16px; border-radius: 20px;
            background: #F3F4F6; color: #6B7280; cursor: pointer;
            transition: all 0.2s; border: 1px solid transparent;
        }
        .tag-radio-label:hover { background: #E5E7EB; }
        .tag-radio-label:has(input:checked) { 
            background: #FFF7ED; color: #C2410C; border-color: #FDBA74; font-weight: 600;
        }

        /* --- ç¼–è¾‘å™¨ï¼šçº¯å‡€çº¸å¼ æ¨¡å¼ (å›ºå®šé«˜åº¦ï¼Œå†…éƒ¨æ»šåŠ¨) --- */
        #view-editor.active { flex-direction: row; background: #E5E7EB; overflow: hidden; }
        .editor-paper-container { 
            flex: 1; display: flex; justify-content: center; align-items: center;
            padding: 0; overflow: hidden; 
        }
        .editor-paper { 
            width: 100%; max-width: 850px; height: 92vh; 
            background: white; 
            box-shadow: 0 20px 40px rgba(0,0,0,0.08); 
            border-radius: 8px; 
            display: flex; flex-direction: column; 
            position: relative;
        }
        .editor-header { 
            padding: 50px 60px 20px 60px; flex: none; 
            border-bottom: 1px solid #F3F4F6;
        }
        #editor-chapter-title {
            font-size: 28px; font-weight: 800; color: #111827;
            border: none; outline: none; width: 100%; background: transparent;
        }
        #editor-content { 
            flex: 1; overflow-y: auto; 
            padding: 30px 60px 80px 60px; 
            font-size: 18px; line-height: 1.85; color: #374151;
            outline: none;
        }
        .editor-right-panel { width: 300px; background: #F9FAFB; border-left: 1px solid #E5E7EB; display: flex; flex-direction: column; flex-shrink: 0; }

        /* AI æŒ‰é’® */
        .btn-ai-mini { 
            font-size: 11px; color: #EA580C; background: #FFF7ED; 
            padding: 2px 8px; border-radius: 6px; font-weight: 600;
            transition: all 0.2s;
        }
        .btn-ai-mini:hover { background: #FED7AA; }

        /* çŠ¶æ€æ ‡è®° */
        .badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: 600; }
        
        [contenteditable]:empty:before { content: attr(placeholder); color: #9CA3AF; display: block; }
        .typing-cursor::after { content: '|'; animation: blink 1s infinite; color: #F97316; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
        
        /* ä¾§è¾¹æ æŠ˜å åŠ¨ç”» */
        .outline-collapsed { height: 0; opacity: 0; overflow: hidden; transform: translateY(-5px); }
        .outline-expanded { height: auto; opacity: 1; transform: translateY(0); }
    </style>
</head>
<body>

<div id="app-container">
    <div id="sidebar">
        <div class="sidebar-header">
            <span class="flex items-center gap-2"><i class="fas fa-feather-alt text-orange-500"></i> AI åˆ›ä½œå°</span>
            <button onclick="openSettings()" class="text-gray-500 hover:text-white transition"><i class="fas fa-cog"></i></button>
        </div>
        <div class="px-3 pb-4 border-b border-gray-800">
            <div onclick="switchPage('view-home')" class="sidebar-item" id="nav-home"><i class="fas fa-book-open mr-3"></i> ä¹¦æ¶</div>
            <div onclick="startNewBook()" class="sidebar-item text-orange-400 hover:bg-orange-500/10"><i class="fas fa-plus-circle mr-3"></i> æ–°å»ºä½œå“</div>
        </div>
        <div id="sidebar-tree-container" class="flex-1 overflow-y-auto py-4 hidden">
            <div class="px-4 text-[10px] font-bold text-gray-600 uppercase tracking-wider mb-2">ç›®å½•ç»“æ„</div>
            <div id="sidebar-tree-content"></div>
        </div>
    </div>

    <div id="main-stage">
        
        <div id="view-home" class="page-view active">
            <div class="px-10 py-8">
                <h1 class="text-3xl font-bold text-gray-900 mb-2">æˆ‘çš„ä½œå“</h1>
                <p class="text-sm text-gray-500">å…± <span id="total-books">0</span> éƒ¨å°è¯´æ­£åœ¨è¿è½½</p>
            </div>
            <div class="card-grid" id="book-list"></div>
        </div>

        <div id="view-create" class="page-view items-center justify-center p-6 bg-gray-100">
            <div class="bg-white w-full max-w-5xl h-full max-h-[90vh] rounded-2xl shadow-xl flex flex-col overflow-hidden">
                <div class="px-8 py-5 border-b flex justify-between items-center bg-white sticky top-0 z-10">
                    <h2 class="text-xl font-bold text-gray-800">åˆ›å»ºæ–°ä¹¦è®¾å®š</h2>
                    <button onclick="switchPage('view-home')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-lg"></i></button>
                </div>
                <div class="flex-1 overflow-y-auto p-8">
                    <div class="grid grid-cols-12 gap-10">
                        <div class="col-span-5 space-y-6">
                            <div class="design-input-group">
                                <label class="design-label">æ ¸å¿ƒå—ä¼—</label>
                                <div class="flex gap-3">
                                    <label class="flex-1 border-2 border-gray-100 rounded-xl p-3 text-center cursor-pointer hover:border-orange-200 transition has-[:checked]:border-orange-500 has-[:checked]:bg-orange-50">
                                        <input type="radio" name="create-audience" value="ç”·é¢‘" checked class="hidden">
                                        <div class="text-sm font-bold text-gray-700">ğŸ‘¦ ç”·é¢‘</div>
                                    </label>
                                    <label class="flex-1 border-2 border-gray-100 rounded-xl p-3 text-center cursor-pointer hover:border-orange-200 transition has-[:checked]:border-orange-500 has-[:checked]:bg-orange-50">
                                        <input type="radio" name="create-audience" value="å¥³é¢‘" class="hidden">
                                        <div class="text-sm font-bold text-gray-700">ğŸ‘§ å¥³é¢‘</div>
                                    </label>
                                </div>
                            </div>
                            <div class="design-input-group">
                                <label class="design-label">ä½œå“ç±»å‹</label>
                                <div class="flex flex-wrap gap-2" id="create-genre-container"></div>
                            </div>
                            <div class="design-input-group">
                                <label class="design-label">ç¯‡å¹…è§„åˆ’</label>
                                <div class="flex gap-4">
                                    <div class="flex-1"><div class="text-xs text-gray-400 mb-1">é¢„è®¡å·æ•°</div><input type="number" id="create-total-volumes" class="design-input text-center font-bold" value="5"></div>
                                    <div class="flex-1"><div class="text-xs text-gray-400 mb-1">æ¯å·ç« æ•°</div><input type="number" id="create-chapters-per-vol" class="design-input text-center font-bold" value="60"></div>
                                </div>
                            </div>
                            <div class="design-input-group pt-4">
                                <label class="design-label">ä¹¦å <div class="flex gap-1"><select id="model-select-create-title" class="text-[10px] border rounded"></select><button onclick="aiHelp('title','create')" class="btn-ai-mini">AIç”Ÿæˆ</button></div></label>
                                <input id="create-title" class="design-input text-2xl font-bold placeholder-gray-300" placeholder="è¾“å…¥éœ¸æ°”ä¹¦å">
                            </div>
                        </div>
                        
                        <div class="col-span-7 space-y-6">
                            <div class="design-input-group">
                                <label class="design-label">é‡‘æ‰‹æŒ‡ / æ ¸å¿ƒæ¢— <div class="flex gap-1"><select id="model-select-create-cheat" class="text-[10px] border rounded"></select><button onclick="aiHelp('cheat','create')" class="btn-ai-mini">AIè„‘æ´</button></div></label>
                                <textarea id="create-cheat" rows="2" class="design-textarea" placeholder="ä¾‹å¦‚ï¼šå¼€å±€ç­¾åˆ°è’å¤åœ£ä½“..." oninput="updateWordCount(this,'create-cheat-count')"></textarea>
                                <div class="text-right text-xs text-gray-400 mt-1"><span id="create-cheat-count">0</span> å­—</div>
                            </div>
                            <div class="design-input-group">
                                <label class="design-label">ä¸»è§’äººè®¾ / å°ä¼  <div class="flex gap-1"><select id="model-select-create-char" class="text-[10px] border rounded"></select><button onclick="aiHelp('char','create')" class="btn-ai-mini">AIå®Œå–„</button></div></label>
                                <textarea id="create-char" rows="3" class="design-textarea" placeholder="å§“åã€æ€§æ ¼ã€èƒŒæ™¯æ•…äº‹..." oninput="updateWordCount(this,'create-char-count')"></textarea>
                                <div class="text-right text-xs text-gray-400 mt-1"><span id="create-char-count">0</span> å­—</div>
                            </div>
                            <div class="design-input-group">
                                <label class="design-label">å…¨ä¹¦ç®€ä»‹ <div class="flex gap-1"><select id="model-select-create-synopsis" class="text-[10px] border rounded"></select><button onclick="aiHelp('synopsis','create')" class="btn-ai-mini">AIæ’°å†™</button></div></label>
                                <textarea id="create-synopsis" rows="5" class="design-textarea" placeholder="å¸å¼•äººçš„ç®€ä»‹..." oninput="updateWordCount(this,'create-synopsis-count')"></textarea>
                                <div class="text-right text-xs text-gray-400 mt-1"><span id="create-synopsis-count">0</span> å­—</div>
                            </div>
                            <div class="design-input-group">
                                <label class="design-label text-blue-600">AI é£æ ¼æŒ‡ä»¤</label>
                                <textarea id="create-system-prompt" rows="2" class="design-textarea bg-blue-50 border-blue-100 text-blue-900 focus:bg-white" placeholder="ä¾‹å¦‚ï¼šæ–‡é£å¹½é»˜ï¼Œå¤šç”¨çŸ­å¥ï¼Œç¦æ­¢ç¿»è¯‘è…”..." oninput="updateWordCount(this,'create-prompt-count')"></textarea>
                                <div class="text-right text-xs text-gray-400 mt-1"><span id="create-prompt-count">0</span> å­—</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="p-6 border-t bg-gray-50 flex justify-end">
                    <button onclick="submitCreation()" class="bg-orange-500 text-white px-8 py-3 rounded-xl font-bold shadow-lg hover:bg-orange-600 hover:scale-105 transition transform">ç«‹å³åˆ›å»ºä½œå“</button>
                </div>
            </div>
        </div>

        <div id="view-overview" class="page-view bg-white">
            <div class="border-b px-8 py-4 flex justify-between items-center sticky top-0 bg-white/95 backdrop-blur z-20">
                <div class="flex items-center gap-4">
                    <h2 class="text-2xl font-bold text-gray-900" id="overview-title">å…¨ä¹¦æ¶æ„</h2>
                    <button onclick="openBookSettings()" class="text-xs font-bold text-gray-500 bg-gray-100 px-3 py-1.5 rounded-full hover:bg-gray-200 transition"><i class="fas fa-sliders-h mr-1"></i>è®¾å®š</button>
                </div>
                <button onclick="addVolume()" class="bg-orange-500 text-white px-4 py-2 rounded-lg text-sm font-bold shadow hover:bg-orange-600 transition"><i class="fas fa-plus mr-2"></i>æ–°å»ºåˆ†å·</button>
            </div>
            <div class="p-10 max-w-6xl mx-auto w-full space-y-10">
                <div class="bg-white border border-gray-200 rounded-2xl p-8 shadow-sm">
                    <div class="flex justify-between items-center mb-6">
                        <div class="flex items-center gap-3">
                            <div class="w-1 h-6 bg-orange-500 rounded-full"></div>
                            <h3 class="text-lg font-bold text-gray-800">å…¨ä¹¦æ€»å‰§æƒ…çº¿</h3>
                        </div>
                        <div class="flex gap-2">
                             <select id="model-select-total" class="text-xs border rounded px-2"></select>
                             <button onclick="aiGenerateTotalOutline()" class="bg-orange-50 text-orange-600 px-3 py-1 rounded text-xs font-bold hover:bg-orange-100 transition">AI è§„åˆ’</button>
                             <button onclick="saveTotalOutline()" class="bg-orange-500 text-white px-4 py-1 rounded text-xs font-bold hover:bg-orange-600 transition">ä¿å­˜</button>
                        </div>
                    </div>
                    <textarea id="total-outline-input" class="w-full h-48 bg-gray-50 rounded-xl p-5 text-sm text-gray-700 leading-relaxed outline-none focus:ring-2 ring-orange-100 transition resize-none" placeholder="åœ¨æ­¤è§„åˆ’å…¨ä¹¦çš„ä¸»çº¿å‰§æƒ…ï¼Œèµ·æ‰¿è½¬åˆ..." oninput="updateWordCount(this,'total-outline-count')"></textarea>
                    <div class="text-right text-xs text-gray-400 mt-1"><span id="total-outline-count">0</span> å­—</div>
                </div>

                <div>
                    <div class="flex justify-between items-end mb-6 border-b border-gray-100 pb-2">
                        <span class="text-lg font-bold text-gray-800">åˆ†å·ç®¡ç†</span>
                        <div class="flex gap-3 items-center">
                            <select id="model-select-volumes" class="text-xs border rounded h-8 px-2"></select>
                            <button onclick="aiAddNextVolume()" class="bg-orange-50 text-orange-600 px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-orange-100 transition"><i class="fas fa-plus-circle mr-1"></i> ç»­å†™ä¸‹ä¸€å·</button>
                            <button onclick="aiGenerateVolumes()" class="bg-orange-100 text-orange-600 px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-orange-200 transition"><i class="fas fa-magic mr-1"></i> é‡æ„å…¨éƒ¨åˆ†å·</button>
                        </div>
                    </div>
                    <div id="volume-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 pb-20"></div>
                </div>
            </div>
        </div>

        <div id="view-volume" class="page-view bg-white">
            <div class="border-b px-8 py-4 flex justify-between items-center sticky top-0 bg-white/95 backdrop-blur z-20">
                <div class="flex items-center gap-4">
                    <button onclick="switchPage('view-overview')" class="text-gray-400 hover:text-gray-800 transition"><i class="fas fa-arrow-left text-lg"></i></button>
                    <div class="h-6 w-px bg-gray-200"></div>
                    <h2 class="text-xl font-bold text-gray-900" id="volume-title-header">åˆ†å·è¯¦æƒ…</h2>
                </div>
                <button onclick="addChapter()" class="bg-gray-900 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-black transition"><i class="fas fa-plus mr-2"></i> æ–°å»ºç« èŠ‚</button>
            </div>
            <div class="p-10 max-w-6xl mx-auto w-full">
                <div class="bg-white border border-gray-200 rounded-2xl p-8 shadow-sm mb-8">
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex items-center gap-3">
                            <div class="w-1 h-6 bg-orange-500 rounded-full"></div>
                            <h3 class="text-lg font-bold text-gray-800">æœ¬å·å¤§çº²</h3>
                        </div>
                        <span id="vol-outline-save-status" class="text-xs text-green-600 opacity-0 transition-opacity font-bold"><i class="fas fa-check"></i> å·²ä¿å­˜</span>
                    </div>
                    <textarea id="current-volume-outline" class="w-full h-24 bg-gray-50 rounded-xl p-4 text-sm text-gray-700 leading-relaxed outline-none focus:ring-2 ring-orange-100 transition resize-none" oninput="autoSaveVolumeOutline();updateWordCount(this,'vol-outline-count')"></textarea>
                    <div class="text-right text-xs text-gray-400 mt-1"><span id="vol-outline-count">0</span> å­—</div>
                </div>
                
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-gray-800 text-lg">ç« èŠ‚åˆ—è¡¨ (<span id="chapter-count">0</span>)</h3>
                    <div class="flex gap-2">
                        <select id="model-select-chapters" class="text-xs border rounded h-8 px-2"></select>
                        <button onclick="parseChaptersFromOutline()" class="bg-green-50 text-green-600 px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-green-100 transition"><i class="fas fa-file-import mr-1"></i>è§£æå¤§çº²</button>
                        <button onclick="aiAddNextChapter()" class="bg-orange-50 text-orange-600 px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-orange-100 transition"><i class="fas fa-plus-circle mr-1"></i>ç»­ä¸€ç« </button>
                        <button onclick="aiGenerateChapters()" class="bg-orange-100 text-orange-600 px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-orange-200 transition"><i class="fas fa-magic mr-1"></i>AIå¡«å……</button>
                    </div>
                </div>
                <div id="batch-delete-bar" class="hidden bg-red-50 border border-red-200 rounded-lg p-3 mb-4 flex justify-between items-center">
                    <span class="text-sm text-red-600"><span id="selected-count">0</span> ç« å·²é€‰ä¸­</span>
                    <div class="flex gap-2">
                        <button onclick="selectAllChapters()" class="text-xs text-orange-600 px-3 py-1.5 rounded border border-orange-200 hover:bg-orange-50">å…¨é€‰</button>
                        <button onclick="cancelBatchDelete()" class="text-xs text-gray-600 px-3 py-1.5 rounded border hover:bg-gray-50">å–æ¶ˆ</button>
                        <button onclick="confirmBatchDelete()" class="text-xs text-white bg-red-500 px-3 py-1.5 rounded hover:bg-red-600">åˆ é™¤é€‰ä¸­</button>
                    </div>
                </div>
                <div class="flex justify-end mb-3">
                    <button onclick="toggleBatchDeleteMode()" id="btn-batch-delete" class="text-xs text-red-400 px-3 py-1.5 rounded hover:bg-red-50 transition"><i class="fas fa-trash-alt mr-1"></i>æ‰¹é‡åˆ é™¤</button>
                </div>
                <div id="chapter-list" class="space-y-3"></div>
            </div>
        </div>

        <div id="view-editor" class="page-view">
            <div class="editor-paper-container">
                <div class="editor-paper">
                    <div class="editor-header">
                        <input type="text" id="editor-chapter-title" placeholder="è¾“å…¥ç« èŠ‚æ ‡é¢˜..." oninput="updateChapterTitle()">
                    </div>
                    <div id="editor-content" contenteditable="true" placeholder="åœ¨æ­¤å¼€å§‹åˆ›ä½œ..." oninput="onEditorInput()"></div>
                </div>
            </div>
            
            <div class="editor-right-panel">
                <div class="p-5 border-b border-gray-100 flex justify-between items-center">
                    <span class="font-bold text-gray-700 text-xs uppercase tracking-wide">å†™ä½œå·¥å…·</span>
                    <button onclick="saveAndExitEditor()" class="text-gray-400 hover:text-red-500 transition"><i class="fas fa-times text-lg"></i></button>
                </div>
                <div class="flex-1 overflow-y-auto p-5 space-y-6">
                    <div class="bg-white border border-gray-100 rounded-xl p-4 shadow-sm">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-xs text-gray-400">å­—æ•°ç»Ÿè®¡</span>
                            <span class="text-lg font-bold text-gray-800" id="editor-word-count">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-xs text-gray-400">ç›®æ ‡å­—æ•°</span>
                            <input type="number" id="input-word-goal" value="3000" class="w-16 text-xs text-right border-b border-gray-200 outline-none font-bold text-gray-600 focus:border-orange-400">
                        </div>
                    </div>

                    <div class="bg-orange-50/50 border border-orange-100 rounded-xl p-4 flex flex-col gap-3">
                        <div class="flex justify-between items-center">
                            <span class="text-xs font-bold text-orange-800 uppercase">ä¸Šä¸‹æ–‡</span>
                            <button onclick="document.getElementById('drawer-volume-outline').classList.toggle('hidden')" class="text-[10px] text-orange-600 hover:underline">å·å¤§çº²</button>
                        </div>
                        <div id="drawer-volume-outline" class="text-xs text-gray-600 bg-white p-3 rounded-lg hidden leading-relaxed max-h-40 overflow-y-auto border border-orange-100 shadow-sm"></div>
                        
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-xs font-bold text-orange-800">æœ¬ç« ç»†çº²</span>
                                <button onclick="saveCurrentOutline()" class="text-[10px] bg-orange-100 text-orange-700 px-2 py-0.5 rounded hover:bg-orange-200 transition">ä¿å­˜</button>
                            </div>
                            <textarea id="editor-outline-view" class="w-full h-32 bg-white text-sm text-gray-700 border border-orange-100 rounded-lg p-3 outline-none resize-none focus:ring-2 ring-orange-100 transition" placeholder="æœ¬ç« å‰§æƒ…ç‚¹..." oninput="updateWordCount(this,'editor-outline-count')"></textarea>
                            <div class="text-right text-xs text-gray-400 mt-1"><span id="editor-outline-count">0</span> å­—</div>
                        </div>
                    </div>

                    <div class="bg-white border border-gray-100 rounded-xl p-4 shadow-sm space-y-3">
                        <div class="text-xs font-bold text-gray-400 uppercase">AI åŠ©æ‰‹</div>
                        <select id="model-select-writer" class="w-full text-xs border border-gray-200 rounded-lg px-2 py-2 bg-gray-50 outline-none"></select>
                        <button onclick="aiWriteContent()" class="w-full bg-gradient-to-r from-orange-500 to-red-500 text-white py-2.5 rounded-lg font-bold shadow-md hover:shadow-lg hover:scale-[1.02] transition transform flex items-center justify-center gap-2">
                            <i class="fas fa-pen-fancy"></i> æ™ºèƒ½ç»­å†™
                        </button>
                    </div>
                    
                    <button onclick="copyContent()" class="w-full border border-gray-200 text-gray-500 py-2 rounded-lg text-xs font-bold hover:bg-gray-50 hover:text-gray-800 transition">å¤åˆ¶æ­£æ–‡</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="modal-edit-book" class="hidden fixed inset-0 bg-black/60 z-[100] flex items-center justify-center backdrop-blur-sm">
    <div class="bg-white w-full max-w-5xl h-[85vh] rounded-2xl shadow-2xl flex flex-col overflow-hidden transform transition-all">
        <div class="px-8 py-5 border-b flex justify-between items-center bg-gray-50">
            <h3 class="text-xl font-bold text-gray-800">ç¼–è¾‘ä½œå“è®¾å®š</h3>
            <button onclick="closeBookSettings()" class="text-gray-400 hover:text-red-500 transition"><i class="fas fa-times text-xl"></i></button>
        </div>
        <div class="flex-1 overflow-y-auto p-8">
            <div class="grid grid-cols-12 gap-10">
                <div class="col-span-5 space-y-6">
                    <div class="design-input-group">
                        <label class="design-label">æ ¸å¿ƒå—ä¼—</label>
                        <div class="flex gap-3">
                            <label class="flex-1 border-2 border-gray-100 rounded-xl p-3 text-center cursor-pointer hover:border-orange-200 transition has-[:checked]:border-orange-500 has-[:checked]:bg-orange-50">
                                <input type="radio" name="edit-audience" value="ç”·é¢‘" class="hidden">
                                <div class="text-sm font-bold text-gray-700">ğŸ‘¦ ç”·é¢‘</div>
                            </label>
                            <label class="flex-1 border-2 border-gray-100 rounded-xl p-3 text-center cursor-pointer hover:border-orange-200 transition has-[:checked]:border-orange-500 has-[:checked]:bg-orange-50">
                                <input type="radio" name="edit-audience" value="å¥³é¢‘" class="hidden">
                                <div class="text-sm font-bold text-gray-700">ğŸ‘§ å¥³é¢‘</div>
                            </label>
                        </div>
                    </div>
                    <div class="design-input-group">
                        <label class="design-label">ä½œå“ç±»å‹</label>
                        <div class="flex flex-wrap gap-2" id="edit-genre-container"></div>
                    </div>
                    <div class="design-input-group">
                        <label class="design-label">ç¯‡å¹…è§„åˆ’</label>
                        <div class="flex gap-4">
                            <div class="flex-1"><div class="text-xs text-gray-400 mb-1">é¢„è®¡å·æ•°</div><input type="number" id="edit-total-volumes" class="design-input text-center font-bold"></div>
                            <div class="flex-1"><div class="text-xs text-gray-400 mb-1">æ¯å·ç« æ•°</div><input type="number" id="edit-chapters-per-vol" class="design-input text-center font-bold"></div>
                        </div>
                    </div>
                    <div class="design-input-group pt-4">
                        <label class="design-label">ä¹¦å</label>
                        <input id="edit-title" class="design-input text-2xl font-bold">
                    </div>
                </div>
                
                <div class="col-span-7 space-y-6">
                    <div class="design-input-group">
                        <label class="design-label">é‡‘æ‰‹æŒ‡ / æ ¸å¿ƒæ¢— <div class="flex gap-1"><select id="model-select-edit-cheat" class="text-[10px] border rounded"></select><button onclick="aiHelp('cheat','edit')" class="btn-ai-mini">AIé‡å†™</button></div></label>
                        <textarea id="edit-cheat" rows="2" class="design-textarea" oninput="updateWordCount(this,'edit-cheat-count')"></textarea>
                        <div class="text-right text-xs text-gray-400 mt-1"><span id="edit-cheat-count">0</span> å­—</div>
                    </div>
                    <div class="design-input-group">
                        <label class="design-label">ä¸»è§’äººè®¾ <div class="flex gap-1"><select id="model-select-edit-char" class="text-[10px] border rounded"></select><button onclick="aiHelp('char','edit')" class="btn-ai-mini">AIé‡å†™</button></div></label>
                        <textarea id="edit-char" rows="3" class="design-textarea" oninput="updateWordCount(this,'edit-char-count')"></textarea>
                        <div class="text-right text-xs text-gray-400 mt-1"><span id="edit-char-count">0</span> å­—</div>
                    </div>
                    <div class="design-input-group">
                        <label class="design-label">å…¨ä¹¦ç®€ä»‹ <div class="flex gap-1"><select id="model-select-edit-synopsis" class="text-[10px] border rounded"></select><button onclick="aiHelp('synopsis','edit')" class="btn-ai-mini">AIé‡å†™</button></div></label>
                        <textarea id="edit-synopsis" rows="5" class="design-textarea" oninput="updateWordCount(this,'edit-synopsis-count')"></textarea>
                        <div class="text-right text-xs text-gray-400 mt-1"><span id="edit-synopsis-count">0</span> å­—</div>
                    </div>
                    <div class="design-input-group">
                        <label class="design-label text-blue-600">AI é£æ ¼æŒ‡ä»¤</label>
                        <textarea id="edit-system-prompt" rows="2" class="design-textarea bg-blue-50 border-blue-100 text-blue-900 focus:bg-white" oninput="updateWordCount(this,'edit-prompt-count')"></textarea>
                        <div class="text-right text-xs text-gray-400 mt-1"><span id="edit-prompt-count">0</span> å­—</div>
                    </div>
                </div>
            </div>
            <select id="model-select-edit-generic" class="hidden"></select>
            <select id="model-select-edit-title" class="hidden"></select>
        </div>
        <div class="p-6 border-t bg-gray-50 flex justify-end">
            <button onclick="saveBookSettings()" class="bg-orange-500 text-white px-8 py-3 rounded-xl font-bold shadow-lg hover:bg-orange-600 hover:scale-105 transition transform">ä¿å­˜ä¿®æ”¹</button>
        </div>
    </div>
</div>

<div id="modal-settings" class="hidden fixed inset-0 bg-black/60 z-[100] flex items-center justify-center backdrop-blur-sm">
    <div class="bg-white w-[500px] rounded-2xl shadow-2xl flex flex-col max-h-[80vh] overflow-hidden">
        <div class="p-5 border-b flex justify-between items-center bg-gray-50">
            <h3 class="font-bold text-gray-800">è®¾ç½®ä¸æ•°æ®</h3>
            <button onclick="closeSettings()" class="text-gray-400 hover:text-red-500"><i class="fas fa-times"></i></button>
        </div>
        <div class="flex-1 overflow-y-auto p-6 space-y-8">
            <div>
                <h4 class="text-xs font-bold text-gray-400 uppercase mb-3">æ•°æ®ç®¡ç†</h4>
                <div class="flex gap-3">
                    <button onclick="exportData()" class="flex-1 bg-orange-500 text-white py-2.5 rounded-lg text-sm font-bold hover:bg-orange-600 transition"><i class="fas fa-download mr-2"></i>å¤‡ä»½æ•°æ®</button>
                    <button onclick="triggerImport()" class="flex-1 bg-orange-400 text-white py-2.5 rounded-lg text-sm font-bold hover:bg-orange-500 transition"><i class="fas fa-upload mr-2"></i>æ¢å¤æ•°æ®</button>
                    <input type="file" id="import-file" class="hidden" accept=".json" onchange="handleFileImport(event)">
                </div>
            </div>
            <div>
                <h4 class="text-xs font-bold text-gray-400 uppercase mb-3">æ¨¡å‹é…ç½®</h4>
                <div id="model-list" class="space-y-2 mb-4 max-h-32 overflow-y-auto"></div>
                <div class="bg-gray-50 p-4 rounded-xl border border-gray-100 space-y-3">
                    <input id="setting-name" class="design-input bg-transparent" placeholder="æ¨¡å‹åç§° (å¦‚: GPT-4)">
                    <input id="setting-key" type="password" class="design-input bg-transparent" placeholder="API å¯†é’¥ (sk-...)">
                    <div class="flex gap-2">
                        <input id="setting-url" class="design-input bg-transparent text-xs" placeholder="https://api.openai.com/v1">
                        <input id="setting-model" class="design-input bg-transparent text-xs" placeholder="gpt-4o-mini">
                    </div>
                    <button onclick="saveModelConfig()" class="w-full bg-orange-500 text-white py-2 rounded-lg text-sm font-bold mt-2">æ·»åŠ é…ç½®</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="stream-overlay" class="hidden fixed inset-x-0 bottom-10 z-[200] flex justify-center pointer-events-none">
    <div class="bg-gray-900/90 backdrop-blur text-white shadow-2xl rounded-full px-8 py-4 flex items-center gap-6 pointer-events-auto border border-gray-700">
        <div class="flex items-center gap-3"><div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div><span class="text-sm font-bold font-mono tracking-wider">AI ç”Ÿæˆä¸­...</span></div>
        <button onclick="stopStream()" class="text-xs bg-red-500/20 text-red-300 hover:bg-red-600 hover:text-white px-4 py-1.5 rounded-full border border-red-500/30 transition">åœæ­¢</button>
    </div>
</div>

<div id="json-preview-modal" class="hidden fixed inset-0 bg-black/60 z-[90] flex items-center justify-center p-4 backdrop-blur-sm">
    <div class="bg-white w-full max-w-2xl rounded-2xl p-6 flex flex-col h-[70vh] shadow-2xl">
        <h3 class="font-bold text-lg mb-4 text-gray-800">AI ç»“æ„åŒ–é¢„è§ˆ</h3>
        <textarea id="json-stream-area" class="flex-1 bg-gray-900 text-green-400 p-5 rounded-xl text-xs font-mono outline-none resize-none shadow-inner"></textarea>
        <div class="mt-4 flex justify-end gap-3">
            <button onclick="cancelJson()" class="text-gray-500 hover:text-gray-700 px-4 font-bold text-sm">å–æ¶ˆ</button>
            <button onclick="finishJsonGeneration()" class="bg-orange-500 text-white px-6 py-2 rounded-lg shadow hover:bg-orange-600 font-bold text-sm">ç¡®è®¤åº”ç”¨</button>
        </div>
    </div>
</div>

<script>
    // --- é€»è¾‘å±‚ (ä¿æŒ v6.19 æ ¸å¿ƒé€»è¾‘å®Œå…¨ä¸€è‡´ï¼Œä»…é€‚é…æ–°ID) ---
    const genres = ["ç„å¹»", "éƒ½å¸‚", "ä»™ä¾ ", "ç§‘å¹»", "æ‚¬ç–‘", "åŒäºº", "å†å²", "æ¸¸æˆ"];
    let appState = { models: [], books: [], activeBookId: null, activeVolumeId: null, currentChapterId: null, expandedVolumeIds: [] };
    let abortController = null, streamBuffer = "", jsonTargetType = '';
    let titleUpdateTimeout;

    window.onload = () => { loadState(); renderGenres('create'); renderGenres('edit'); initModelSelects(); loadRouteFromUrl(); };

    // Update Title Logic
    function updateChapterTitle() {
        const val = document.getElementById('editor-chapter-title').value;
        if(appState.activeBookId && appState.activeVolumeId && appState.currentChapterId) {
            const book = getActiveBook(); const vol = book.volumes.find(v => v.id === appState.activeVolumeId); const ch = vol.chapters.find(c => c.id === appState.currentChapterId);
            if(ch) { ch.title = val; saveState(); clearTimeout(titleUpdateTimeout); titleUpdateTimeout = setTimeout(updateSidebar, 500); }
        }
    }

    // Routing
    function syncUrlState() { const url = new URL(window.location); if (appState.activeBookId) url.searchParams.set('b', appState.activeBookId); else url.searchParams.delete('b'); if (appState.activeVolumeId) url.searchParams.set('v', appState.activeVolumeId); else url.searchParams.delete('v'); if (appState.currentChapterId) url.searchParams.set('c', appState.currentChapterId); else url.searchParams.delete('c'); window.history.pushState({}, '', url); }
    function loadRouteFromUrl() {
        const p = new URLSearchParams(window.location.search); const bid = p.get('b'), vid = p.get('v'), cid = p.get('c');
        if (bid) { const book = appState.books.find(x => x.id == bid); if (book) { appState.activeBookId = parseInt(bid); if (vid) { const vol = book.volumes.find(x => x.id == vid); if (vol) { appState.activeVolumeId = parseInt(vid); if (!appState.expandedVolumeIds.includes(appState.activeVolumeId)) appState.expandedVolumeIds.push(appState.activeVolumeId); if (cid) { const ch = vol.chapters.find(x => x.id == cid); if (ch) { appState.currentChapterId = parseInt(cid); openEditor(); return; } } switchPage('view-volume'); return; } } switchPage('view-overview'); return; } } switchPage('view-home');
    }
    window.addEventListener('popstate', loadRouteFromUrl);

    // Sidebar & Navigation
    function openEditor() { switchPage('view-editor'); }
    function toggleSidebarVolume(volId, e) { if(e) e.stopPropagation(); const idx = appState.expandedVolumeIds.indexOf(volId); if (idx > -1) { appState.expandedVolumeIds.splice(idx, 1); } else { appState.expandedVolumeIds.push(volId); } saveState(); updateSidebar(); }
    function updateSidebar() {
        const treeContent = document.getElementById('sidebar-tree-content');
        const treeContainer = document.getElementById('sidebar-tree-container');
        document.querySelectorAll('.sidebar-item').forEach(el => el.classList.remove('active'));
        if (appState.activeBookId && getActiveBook()) {
            document.getElementById('nav-home').classList.remove('active'); treeContainer.classList.remove('hidden');
            const book = getActiveBook();
            let html = `<div onclick="switchPage('view-overview')" class="sidebar-item ${document.getElementById('view-overview').classList.contains('active') ? 'active' : ''} text-gray-400 hover:text-white"><i class="fas fa-sitemap mr-3"></i>å…¨ä¹¦æ€»çº²</div>`;
            if (book.volumes) {
                book.volumes.forEach((vol) => {
                    const isVolActive = appState.activeVolumeId === vol.id && document.getElementById('view-volume').classList.contains('active');
                    const isExpanded = appState.expandedVolumeIds.includes(vol.id);
                    html += `<div class="mt-1"><div class="sidebar-item group ${isVolActive ? 'active' : ''} text-gray-400 hover:text-white justify-between" onclick="appState.activeVolumeId=${vol.id};switchPage('view-volume')"><div class="flex items-center overflow-hidden"><i class="fas fa-folder${isVolActive || isExpanded ? '-open' : ''} mr-3 ${isVolActive ? 'text-white' : 'text-gray-600'}"></i><span class="truncate text-sm">${vol.title}</span></div><button onclick="toggleSidebarVolume(${vol.id}, event)" class="opacity-50 hover:opacity-100 p-1"><i class="fas ${isExpanded ? 'fa-chevron-down' : 'fa-chevron-right'} text-[10px]"></i></button></div><div class="${isExpanded ? 'block' : 'hidden'} ml-4 border-l border-gray-700 pl-1 transition-all">${vol.chapters.map((ch) => `<div onclick="appState.activeVolumeId=${vol.id};appState.currentChapterId=${ch.id};openEditor()" class="sidebar-item ${appState.currentChapterId === ch.id && document.getElementById('view-editor').classList.contains('active') ? 'active text-orange-400' : 'text-gray-500'} text-xs py-1.5 my-0.5"><span class="truncate">${ch.title}</span></div>`).join('')}</div></div>`;
                });
            }
            treeContent.innerHTML = html;
        } else { document.getElementById('nav-home').classList.add('active'); treeContainer.classList.add('hidden'); }
    }

    function switchPage(id) {
        document.querySelectorAll('.page-view').forEach(e => e.classList.remove('active')); document.getElementById(id).classList.add('active');
        if(id === 'view-home') { appState.activeBookId = null; appState.activeVolumeId = null; appState.currentChapterId = null; renderBookList(); }
        else if (id === 'view-overview') { appState.activeVolumeId = null; appState.currentChapterId = null; renderVolumeList(); document.getElementById('total-outline-input').value = getActiveBook().totalOutline||''; document.getElementById('total-outline-count').innerText = countWords(getActiveBook().totalOutline||''); if(getActiveBook()) document.getElementById('overview-title').innerText = getActiveBook().title; }
        else if(id==='view-volume') { 
            appState.currentChapterId = null; renderChapterList(); const vol = getActiveBook().volumes.find(v=>v.id===appState.activeVolumeId);
            document.getElementById('volume-title-header').innerText = vol.title; document.getElementById('current-volume-outline').value = vol.outline||''; document.getElementById('vol-outline-count').innerText = countWords(vol.outline||'');
            if(!appState.expandedVolumeIds.includes(vol.id)) { appState.expandedVolumeIds.push(vol.id); saveState(); }
        }
        else if(id==='view-editor') {
            const c = getActiveBook().volumes.find(v=>v.id===appState.activeVolumeId).chapters.find(c=>c.id===appState.currentChapterId);
            document.getElementById('editor-chapter-title').value = c.title; document.getElementById('editor-content').innerHTML = c.content||''; document.getElementById('editor-outline-view').value = c.outline; document.getElementById('editor-outline-count').innerText = countWords(c.outline||'');
            document.getElementById('drawer-volume-outline').innerText = getActiveBook().volumes.find(v=>v.id===appState.activeVolumeId).outline || "æš‚æ— æœ¬å·å¤§çº²";
            if(appState.activeVolumeId && !appState.expandedVolumeIds.includes(appState.activeVolumeId)) { appState.expandedVolumeIds.push(appState.activeVolumeId); saveState(); }
            onEditorInput();
        }
        syncUrlState(); updateSidebar();
    }

    // --- Book Management (UI Updated) ---
    function renderBookList() {
        const list = document.getElementById('book-list');
        list.innerHTML = appState.books.map(b => `
            <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-100 hover:shadow-xl hover:-translate-y-1 transition duration-300 group relative flex flex-col h-64">
                <div onclick="appState.activeBookId=${b.id};switchPage('view-overview')" class="cursor-pointer flex-1 flex flex-col">
                    <div class="flex justify-between items-start mb-4">
                        <h4 class="font-bold text-xl text-gray-900 group-hover:text-orange-600 transition truncate pr-2">${b.title}</h4>
                        <span class="badge bg-gray-100 text-gray-500">${getBookTotalWords(b)}å­—</span>
                    </div>
                    <div class="flex gap-2 mb-4">
                         <span class="badge bg-orange-50 text-orange-600 border border-orange-100">${b.audience}</span>
                         <span class="badge bg-orange-100 text-orange-700 border border-orange-200">${(b.genre||'').split(' ')[1]||'æœªåˆ†ç±»'}</span>
                    </div>
                    <p class="text-sm text-gray-500 line-clamp-3 leading-relaxed flex-1">${b.synopsis}</p>
                </div>
                <div class="absolute top-4 right-4 opacity-0 group-hover:opacity-100 transition">
                    <button onclick="deleteBook(${b.id}, event)" class="text-gray-300 hover:text-red-500 p-2"><i class="fas fa-trash-alt"></i></button>
                </div>
            </div>`).reverse().join(''); 
        document.getElementById('total-books').innerText = appState.books.length;
    }

    function renderVolumeList() {
        const vList = document.getElementById('volume-list');
        vList.innerHTML = getActiveBook().volumes.map((v, i) => `
            <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm hover:shadow-lg transition relative group cursor-pointer hover:border-orange-300" onclick="appState.activeVolumeId=${v.id};switchPage('view-volume')">
                <div class="flex justify-between items-center mb-3">
                    <span class="font-bold text-gray-900 text-lg">ç¬¬${i+1}å·ï¼š${v.title}</span>
                    <button class="text-gray-300 hover:text-red-500 p-1 opacity-0 group-hover:opacity-100 transition" onclick="deleteVolume(${v.id}, event)"><i class="fas fa-trash-alt"></i></button>
                </div>
                <p class="text-xs text-gray-500 line-clamp-3 mb-4 h-10 leading-relaxed">${v.outline || 'æš‚æ— å¤§çº²...'}</p>
                <div class="flex justify-between items-center text-xs text-gray-400 border-t pt-3">
                    <span><i class="fas fa-layer-group mr-1"></i> ${v.chapters.length} ç« </span>
                    <span>${getVolumeTotalWords(v)} å­—</span>
                </div>
            </div>`).join('');
    }

    function renderChapterList() {
        const v = getActiveBook().volumes.find(v=>v.id===appState.activeVolumeId);
        document.getElementById('chapter-list').innerHTML = v.chapters.map((c, index) => {
            const words = countWords(c.content);
            const status = words > 50 ? `<span class="badge bg-green-50 text-green-600">å·²æ›´ ${words}</span>` : `<span class="badge bg-gray-100 text-gray-400">è‰ç¨¿</span>`;
            const isSelected = selectedChapterIds.includes(c.id);
            const checkbox = batchDeleteMode ? `<input type="checkbox" ${isSelected ? 'checked' : ''} onclick="toggleChapterSelect(${c.id}, event)" class="mr-3 w-4 h-4 accent-orange-500">` : '';
            const clickAction = batchDeleteMode ? `toggleChapterSelect(${c.id}, event)` : `appState.currentChapterId=${c.id};openEditor()`;
            const borderClass = isSelected ? 'border-red-400 bg-red-50' : 'border-gray-100 hover:border-orange-200';
            return `
            <div class="bg-white p-4 rounded-xl border ${borderClass} hover:shadow-md transition flex justify-between items-center group relative cursor-pointer" onclick="${clickAction}">
                <div class="flex-1 flex items-center justify-between pr-4">
                    <div class="flex items-center gap-3">
                        ${checkbox}
                        <span class="text-gray-400 font-mono text-sm">#${index+1}</span>
                        <span class="font-bold text-gray-800">${c.title}</span>
                    </div>
                    ${status}
                </div>
                ${!batchDeleteMode ? `<button onclick="deleteChapter(${c.id}, event)" class="text-gray-300 hover:text-red-500 p-2 opacity-0 group-hover:opacity-100 transition"><i class="fas fa-trash-alt"></i></button>` : ''}
            </div>`;
        }).join('');
        document.getElementById('chapter-count').innerText = v.chapters.length;
    }

    // --- Book Settings Logic (UI Updated to Match Create) ---
    function openBookSettings() { 
        const b=getActiveBook(); if(!b)return; 
        const auds=document.getElementsByName('edit-audience'); for(let r of auds)r.checked=(r.value===b.audience); 
        renderGenres('edit'); const trg=b.genre?b.genre.split(' ')[1]||'ç„å¹»':'ç„å¹»'; const grs=document.getElementsByName('edit-genre'); for(let r of grs)r.checked=(r.value===trg); 
        document.getElementById('edit-title').value=b.title; 
        document.getElementById('edit-total-volumes').value=b.totalVolCount||5; document.getElementById('edit-chapters-per-vol').value=b.chaptersPerVol||20; 
        document.getElementById('edit-cheat').value=b.cheat||""; document.getElementById('edit-char').value=b.charInfo||""; 
        document.getElementById('edit-synopsis').value=b.synopsis||""; document.getElementById('edit-system-prompt').value=b.systemPrompt||""; 
        // åˆå§‹åŒ–å­—æ•°ç»Ÿè®¡
        document.getElementById('edit-cheat-count').innerText = countWords(b.cheat||"");
        document.getElementById('edit-char-count').innerText = countWords(b.charInfo||"");
        document.getElementById('edit-synopsis-count').innerText = countWords(b.synopsis||"");
        document.getElementById('edit-prompt-count').innerText = countWords(b.systemPrompt||"");
        ['title','cheat','char','synopsis'].forEach(k=>{const s=document.getElementById(`model-select-edit-${k}`);if(s)s.innerHTML=document.getElementById('model-select-create-title').innerHTML;});
        document.getElementById('modal-edit-book').classList.remove('hidden'); 
    }
    function saveBookSettings() { 
        const b=getActiveBook(); 
        b.audience=document.querySelector('input[name="edit-audience"]:checked').value; 
        b.genre=b.audience+" "+document.querySelector('input[name="edit-genre"]:checked').value; 
        b.title=document.getElementById('edit-title').value; b.totalVolCount=document.getElementById('edit-total-volumes').value; b.chaptersPerVol=document.getElementById('edit-chapters-per-vol').value; 
        b.cheat=document.getElementById('edit-cheat').value; b.charInfo=document.getElementById('edit-char').value; b.synopsis=document.getElementById('edit-synopsis').value; b.systemPrompt=document.getElementById('edit-system-prompt').value; 
        saveState(); closeBookSettings(); 
        if(document.getElementById('view-overview').classList.contains('active')) document.getElementById('overview-title').innerText=b.title; alert("è®¾å®šå·²æ›´æ–°"); 
    }
    function closeBookSettings() { document.getElementById('modal-edit-book').classList.add('hidden'); }

    // --- Standard Utils (Copied from v6.19) ---
    function startJsonStream(prompt, mid, type) { jsonTargetType=type; document.getElementById('json-preview-modal').classList.remove('hidden'); const v = document.getElementById('json-stream-area'); v.value = ""; streamBuffer = ""; streamAI(prompt, "åªè¾“å‡ºçº¯JSONæ•°ç»„ï¼Œç¦æ­¢ä»»ä½•è§£é‡Šã€markdownã€ä»£ç å—ã€‚æ ¼å¼ï¼š[{...}]", mid, (c)=>{streamBuffer+=c; v.value+=c; v.scrollTop=v.scrollHeight}, ()=>{ document.getElementById('stream-status').innerText="å®Œæˆ"; }); }
    function finishJsonGeneration() { try { let jsonStr = document.getElementById('json-stream-area').value; let j = []; const firstBracket = jsonStr.indexOf('['); const lastBracket = jsonStr.lastIndexOf(']'); if (firstBracket !== -1 && lastBracket !== -1 && lastBracket > firstBracket) { let cleanJson = jsonStr.substring(firstBracket, lastBracket + 1); cleanJson = cleanJson.replace(/```json/gi, "").replace(/```/g, "").replace(/ï¼Œ/g, ",").replace(/ï¼š/g, ":").replace(/"/g, '"').replace(/"/g, '"').replace(/'/g, "'").replace(/'/g, "'").trim(); cleanJson = cleanJson.replace(/,\s*]/g, ']').replace(/,\s*}/g, '}'); try { j = JSON.parse(cleanJson); } catch(e1) { const items = []; const regex = /\{\s*"title"\s*:\s*"([^"]*?)"\s*,\s*"outline"\s*:\s*"([^"]*?)"\s*\}/g; let match; while ((match = regex.exec(cleanJson)) !== null) { items.push({ title: match[1], outline: match[2] }); } if (items.length > 0) j = items; } } if (j.length === 0) { const textLines = jsonStr.split(/\\n|\n/); textLines.forEach(line => { const chapterMatch = line.match(/ç¬¬(\d+)ç« [ï¼š:]\s*(.+?)\s*[-â€“â€”]\s*(.+)/); if (chapterMatch) { j.push({ title: `ç¬¬${chapterMatch[1]}ç« ï¼š${chapterMatch[2].trim()}`, outline: chapterMatch[3].trim() }); } else { const simpleMatch = line.match(/ç¬¬(\d+)ç« [ï¼š:]\s*(.+)/); if (simpleMatch) { j.push({ title: `ç¬¬${simpleMatch[1]}ç« `, outline: simpleMatch[2].trim() }); } } }); } if (j.length === 0) { const globalRegex = /ç¬¬(\d+)ç« [ï¼š:]\s*([^\\n\nç¬¬]+?)(?:\s*[-â€“â€”]\s*([^\\n\nç¬¬]+))?/g; let match; while ((match = globalRegex.exec(jsonStr)) !== null) { j.push({ title: `ç¬¬${match[1]}ç« ï¼š${(match[2]||'').trim()}`, outline: (match[3] || match[2] || '').trim() }); } } if (j.length === 0) throw new Error("æ— æ³•è§£æå†…å®¹ï¼Œè¯·æ£€æŸ¥AIè¾“å‡ºæ ¼å¼"); let mappedData = []; j.forEach(item => { const title = item.title || item.chapter_title || "æœªå‘½å"; const rangeMatch = title.match(/(\d+)\s*[-~è‡³åˆ°]\s*(\d+)/); if (jsonTargetType === 'chapter' && rangeMatch) { const start = parseInt(rangeMatch[1]); const end = parseInt(rangeMatch[2]); if (end > start && (end - start) < 100) { for (let k = start; k <= end; k++) { mappedData.push({ title: `ç¬¬${k}ç« `, outline: item.outline || item.synopsis || "..." }); } return; } } mappedData.push({ title: title, outline: item.outline || item.synopsis || "..." }); }); if(jsonTargetType==='volume') { if(!getActiveBook().volumes) getActiveBook().volumes=[]; mappedData.forEach((x,i)=>getActiveBook().volumes.push({id:Date.now()+i, title:x.title, outline:x.outline, chapters:[]})); renderVolumeList(); } else { const v=getActiveBook().volumes.find(v=>v.id===appState.activeVolumeId); mappedData.forEach((x,i)=>v.chapters.push({id:Date.now()+i, title:x.title, outline:x.outline, content:''})); renderChapterList(); } saveState(); cancelJson(); updateSidebar(); alert("æˆåŠŸè§£æ " + mappedData.length + " æ¡æ•°æ®"); } catch(e){ alert("è§£æå¤±è´¥: " + e.message + "\n\nå»ºè®®ï¼šç­‰AIå®Œå…¨è¾“å‡ºåå†ç‚¹ç¡®è®¤"); } }
    function aiGenerateChapters() { const b = getActiveBook(); const v = b.volumes.find(v=>v.id===appState.activeVolumeId); if(!v.outline || v.outline.length < 5) return alert("âŒ æœ¬å·å¤§çº²ä¸ºç©ºï¼"); const targetCount = parseInt(b.chaptersPerVol) || 20; const currentCount = v.chapters.length; const remaining = targetCount - currentCount; if (remaining <= 0) { if(!confirm(`æœ¬å·å·²è¾¾æ ‡ (${targetCount}ç« )ï¼Œæ˜¯å¦ç»§ç»­ç”Ÿæˆï¼Ÿ`)) return; } const genCount = remaining > 0 ? remaining : targetCount; const volIndex = b.volumes.findIndex(vol => vol.id === v.id); let prevChaptersTotal = 0; for(let i = 0; i < volIndex; i++) { prevChaptersTotal += b.volumes[i].chapters.length; } const startChapterNum = prevChaptersTotal + currentCount + 1; const endChapterNum = startChapterNum + genCount - 1; const prompt = `è§„åˆ’${genCount}ç« ã€‚ä¹¦åã€Š${b.title}ã€‹å·ã€Š${v.title}ã€‹å¤§çº²ï¼š${v.outline}\næœ¬å·å·²æœ‰${currentCount}ç« ï¼Œç°åœ¨è§„åˆ’ç¬¬${startChapterNum}ç« åˆ°ç¬¬${endChapterNum}ç« ï¼Œå…±${genCount}ç« ã€‚\nè¾“å‡ºJSONï¼š[{"title":"ç¬¬${startChapterNum}ç«  ç« å","outline":"è¯¦ç»†å¤§çº²"},{"title":"ç¬¬${startChapterNum+1}ç«  ç« å","outline":"è¯¦ç»†å¤§çº²"}...]ï¼Œç« èŠ‚ç¼–å·å¿…é¡»ä»${startChapterNum}å¼€å§‹è¿ç»­é€’å¢åˆ°${endChapterNum}ï¼Œæ¯ç« å¤§çº²50-100å­—åŒ…å«æ ¸å¿ƒå†²çªã€å…³é”®æƒ…èŠ‚ã€äººç‰©äº’åŠ¨ã€‚`; startJsonStream(prompt, document.getElementById('model-select-chapters').value, 'chapter'); }
    function toggleVolumeOutline() { const el = document.getElementById('current-volume-outline'); const btn = document.getElementById('btn-toggle-vol-outline'); if (el.classList.contains('outline-collapsed')) { el.classList.remove('outline-collapsed'); el.classList.add('outline-expanded'); btn.innerHTML = 'æ”¶èµ·'; } else { el.classList.remove('outline-expanded'); el.classList.add('outline-collapsed'); btn.innerHTML = 'å±•å¼€æŸ¥çœ‹è¯¦æƒ…'; } }
    let volSaveTimeout; function autoSaveVolumeOutline() { document.getElementById('vol-outline-save-status').classList.remove('opacity-0'); clearTimeout(volSaveTimeout); volSaveTimeout = setTimeout(() => { const b = getActiveBook(); const v = b.volumes.find(vol => vol.id === appState.activeVolumeId); v.outline = document.getElementById('current-volume-outline').value; saveState(); document.getElementById('vol-outline-save-status').classList.add('opacity-0'); }, 800); }
    function countWords(s) { return s ? s.replace(/\s+/g, '').length : 0; }
    function updateWordCount(el, countId) { document.getElementById(countId).innerText = countWords(el.value); }
    function getBookTotalWords(b) { return b.volumes ? b.volumes.reduce((a,v)=>a+getVolumeTotalWords(v),0) : 0; }
    function getVolumeTotalWords(v) { return v.chapters ? v.chapters.reduce((a,c)=>a+countWords(c.content),0) : 0; }
    function getActiveBook() { return appState.books.find(b => b.id === appState.activeBookId); }
    function saveState() { localStorage.setItem('ai_novel_pc_v6_21', JSON.stringify(appState)); }
    function loadState() { const s = localStorage.getItem('ai_novel_pc_v6_21'); if(s) { appState = JSON.parse(s); } else { const old = localStorage.getItem('ai_novel_pc_v6_19'); if(old) { appState = JSON.parse(old); saveState(); console.log("Migrated v6.19"); } } if(!appState.models) appState.models = []; if(!appState.books) appState.books = []; if(!appState.expandedVolumeIds) appState.expandedVolumeIds = []; }
    async function streamAI(prompt, systemPrompt, modelId, onChunk, onDone) { const m = appState.models.find(x => x.id === modelId); if(!m) return alert("è¯·åœ¨è®¾ç½®ä¸­é…ç½®æ¨¡å‹"); document.getElementById('stream-overlay').classList.remove('hidden'); abortController = new AbortController(); try { const res = await fetch(`${m.url.replace(/\/$/, "")}/chat/completions`, { method:'POST', headers:{'Content-Type':'application/json','Authorization':`Bearer ${m.key}`}, body:JSON.stringify({model:m.modelName, messages:[{role:"system",content:systemPrompt},{role:"user",content:prompt}], temperature:0.7, stream:true}), signal:abortController.signal }); const reader = res.body.getReader(); const decoder = new TextDecoder(); let fullText=""; while(true) { const {done, value} = await reader.read(); if(done) break; const lines = decoder.decode(value, {stream:true}).split('\n'); for(const line of lines) { if(line.startsWith('data: ')) { const jsonStr = line.slice(6); if(jsonStr==='[DONE]') return; try { const t = JSON.parse(jsonStr).choices[0].delta.content||""; fullText+=t; onChunk(t, fullText); } catch(e){} } } } if(onDone) onDone(fullText); } catch(e){ if(e.name!=='AbortError') alert(e.message); } finally { document.getElementById('stream-overlay').classList.add('hidden'); abortController=null; } }
    function stopStream() { if(abortController) abortController.abort(); }
    function aiHelp(field, context) { let selectId = context === 'create' ? `model-select-create-${field}` : `model-select-edit-${field}`; let targetId = context === 'create' ? `create-${field}` : `edit-${field}`; const titleVal = document.getElementById(`${context}-title`).value; const aud = document.querySelector(`input[name="${context}-audience"]:checked`).value; const gen = document.querySelector(`input[name="${context}-genre"]:checked`)?.value || 'æœªåˆ†ç±»'; let prompt = ""; const sys = "ç›´æ¥è¾“å‡ºå†…å®¹ï¼Œç¦æ­¢å¼€åœºç™½ã€è§£é‡Šã€æ€»ç»“ã€markdownæ ¼å¼ã€‚"; if(field === 'title') prompt = `ç”Ÿæˆä¹¦åã€‚å—ä¼—ï¼š${aud}ï¼Œç±»å‹ï¼š${gen}ã€‚åªè¾“å‡ºä¹¦åæœ¬èº«ã€‚`; else if (field === 'cheat') prompt = `è®¾è®¡é‡‘æ‰‹æŒ‡ã€‚ä¹¦åï¼š${titleVal}ï¼Œç±»å‹ï¼š${aud} ${gen}ã€‚50å­—å†…ï¼Œåªè¾“å‡ºé‡‘æ‰‹æŒ‡å†…å®¹ã€‚`; else if (field === 'char') prompt = `ç”Ÿæˆä¸»è§’äººè®¾ã€‚ä¹¦åï¼š${titleVal}ã€‚100å­—å·¦å³ï¼Œåªè¾“å‡ºäººè®¾å†…å®¹ã€‚`; else if (field === 'synopsis') prompt = `å†™ç®€ä»‹ã€‚ä¹¦åï¼š${titleVal}ï¼Œç±»å‹ï¼š${aud} ${gen}ã€‚200å­—ï¼Œåªè¾“å‡ºç®€ä»‹å†…å®¹ã€‚`; const target = document.getElementById(targetId); target.value = ""; streamAI(prompt, sys, document.getElementById(selectId).value, (c) => target.value += c); }
    function aiGenerateTotalOutline() { const b = getActiveBook(); const el = document.getElementById('total-outline-input'); el.value = ""; const volCount = b.totalVolCount || 5; const chPerVol = b.chaptersPerVol || 20; const p = `ã€Š${b.title}ã€‹
ç®€ä»‹ï¼š${b.synopsis}
é‡‘æ‰‹æŒ‡ï¼š${b.cheat}
ä¸»è§’ï¼š${b.charInfo}

è¦æ±‚ï¼š${volCount}å·ï¼Œæ¯å·${chPerVol}ç« 

æ ¼å¼ï¼š
ç¬¬ä¸€å·ï¼šå·å
ï¼ˆæœ¬å·ä¸»çº¿ï¼‰
ç¬¬1ç« ï¼šç« å - å‰§æƒ…
ç¬¬2ç« ï¼šç« å - å‰§æƒ…
...å…±${chPerVol}ç« 

ç¬¬äºŒå·ï¼šå·å
...

å†™æ»¡${volCount}å·ï¼Œæ¯å·${chPerVol}ç« ã€‚`; streamAI(p, "ç›´æ¥è¾“å‡ºå¤§çº²å†…å®¹ï¼Œç¦æ­¢ä»»ä½•å¼€åœºç™½ã€è§£é‡Šã€æ€»ç»“ã€‚ä¸¥æ ¼æŒ‰æ ¼å¼è¾“å‡ºï¼Œä¸é—æ¼ä»»ä½•ä¸€å·ä¸€ç« ã€‚", document.getElementById('model-select-total').value, (c)=>el.value+=c, ()=>saveTotalOutline()); }
    function saveTotalOutline() { getActiveBook().totalOutline = document.getElementById('total-outline-input').value; saveState(); }
    function aiGenerateVolumes() { const o=document.getElementById('total-outline-input').value; if(!o) return alert("è¯·å…ˆå†™å¤§çº²"); startJsonStream(`æ‹†è§£åˆ†å·ã€‚å¤§çº²ï¼š${o}\nè¾“å‡ºJSONï¼š[{"title":"å·å","outline":"å¤§çº²"}]`, document.getElementById('model-select-volumes').value, 'volume'); }
    function aiAddNextVolume() { const currentOutline = document.getElementById('total-outline-input').value; const b = getActiveBook(); if(!currentOutline) return alert("è¯·å…ˆå¡«å†™æ€»å¤§çº²"); const prevVolumes = b.volumes.map(v => v.title).join('\n'); const prompt = `ç»­å†™ä¸‹ä¸€å·ã€‚æ€»å¤§çº²ï¼š${currentOutline}\nå·²æœ‰å·ï¼š${prevVolumes}\nè¾“å‡ºJSONï¼š[{"title":"å·å","outline":"å¤§çº²"}]`; startJsonStream(prompt, document.getElementById('model-select-volumes').value, 'volume'); }
    function parseChaptersFromOutline() {
        const b = getActiveBook();
        const v = b.volumes.find(v => v.id === appState.activeVolumeId);
        if(!v.outline || v.outline.length < 10) return alert("âŒ æœ¬å·å¤§çº²ä¸ºç©ºï¼Œè¯·å…ˆå¡«å†™å¤§çº²ï¼");
        
        const lines = v.outline.split('\n');
        const chapters = [];
        
        for(const line of lines) {
            const match = line.match(/ç¬¬(\d+)ç« [ï¼š:\s]+(.+?)\s*[-â€“â€”]\s*(.+)/);
            if(match) {
                chapters.push({ title: `ç¬¬${match[1]}ç« ï¼š${match[2].trim()}`, outline: match[3].trim() });
                continue;
            }
            const match2 = line.match(/ç¬¬(\d+)ç« [ï¼š:\s]+(.+)/);
            if(match2 && !match) {
                chapters.push({ title: `ç¬¬${match2[1]}ç« ï¼š${match2[2].trim()}`, outline: '' });
            }
        }
        
        if(chapters.length === 0) {
            return alert("âŒ æœªèƒ½ä»å¤§çº²ä¸­è§£æå‡ºç« èŠ‚ï¼\n\nè¯·ç¡®ä¿å¤§çº²æ ¼å¼ä¸ºï¼š\nç¬¬Xç« ï¼šç« å - å¤§çº²å†…å®¹\n\nä¾‹å¦‚ï¼š\nç¬¬61ç« ï¼šæ°´å¡”å…±å’Œå›½ - 2001å¹´æ–°ä¸–çºªï¼Œæ°´å¡”åªå‰©æå»ºå›½å’Œå‡ ä¸ªè€äººã€‚");
        }
        
        if(!confirm(`ä»å¤§çº²ä¸­è§£æå‡º ${chapters.length} ç« ï¼Œæ˜¯å¦å¯¼å…¥ï¼Ÿ\n\nå‰3ç« é¢„è§ˆï¼š\n${chapters.slice(0,3).map(c=>c.title).join('\n')}`)) return;
        
        chapters.forEach((c, i) => {
            v.chapters.push({ id: Date.now() + i, title: c.title, outline: c.outline, content: '' });
        });
        
        saveState();
        renderChapterList();
        alert(`âœ… æˆåŠŸå¯¼å…¥ ${chapters.length} ç« ï¼`);
    }
    function aiAddNextChapter() { const b = getActiveBook(); const v = b.volumes.find(v => v.id === appState.activeVolumeId); const volIndex = b.volumes.findIndex(vol => vol.id === v.id); let prevChaptersTotal = 0; for(let i = 0; i < volIndex; i++) { prevChaptersTotal += b.volumes[i].chapters.length; } const nextChapterNum = prevChaptersTotal + v.chapters.length + 1; const prevChapters = v.chapters.slice(-3).map(c => c.title).join('\n'); const prompt = `è§„åˆ’ä¸‹ä¸€ç« ï¼ˆç¬¬${nextChapterNum}ç« ï¼‰ã€‚ä¹¦åã€Š${b.title}ã€‹å·ã€Š${v.title}ã€‹\nå·å¤§çº²ï¼š${v.outline}\næœ€è¿‘ç« èŠ‚ï¼š${prevChapters}\nè¾“å‡ºJSONï¼š[{"title":"ç¬¬${nextChapterNum}ç«  ç« å","outline":"å¤§çº²"}]`; startJsonStream(prompt, document.getElementById('model-select-chapters').value, 'chapter'); }
    function aiWriteContent() { const b = getActiveBook(); const v = b.volumes.find(x=>x.id===appState.activeVolumeId); const c = v.chapters.find(x=>x.id===appState.currentChapterId); const ed = document.getElementById('editor-content'); const wordGoal = parseInt(document.getElementById('input-word-goal').value) || 2500; const chapterIndex = v.chapters.findIndex(x=>x.id===appState.currentChapterId); let prevContext = ''; for(let i = Math.max(0, chapterIndex - 3); i < chapterIndex; i++) { const prevChapter = v.chapters[i]; if(prevChapter.content && prevChapter.content.length > 0) { prevContext += `ã€${prevChapter.title}ç‰‡æ®µã€‘${prevChapter.content.slice(-800)}\n\n`; } } const currentWords = ed.innerText.length; const remainingWords = Math.max(wordGoal - currentWords, 500); const sys = `ä½ æ˜¯ä¸“ä¸šç½‘æ–‡ä½œå®¶ï¼Œç»­å†™å°è¯´æ­£æ–‡ã€‚\n\nã€ä½œå“ä¿¡æ¯ã€‘\nä¹¦åï¼š${b.title}\nç±»å‹ï¼š${b.genre}\né‡‘æ‰‹æŒ‡ï¼š${b.cheat}\nä¸»è§’ï¼š${b.charInfo}\né£æ ¼ï¼š${b.systemPrompt}\næœ¬å·å¤§çº²ï¼š${v.outline}\næœ¬ç« å¤§çº²ï¼š${c.outline}\n\nã€å­—æ•°æ§åˆ¶ã€‘\nå½“å‰ç« èŠ‚å·²æœ‰${currentWords}å­—ï¼Œç›®æ ‡æ€»å­—æ•°${wordGoal}å­—ã€‚\næœ¬æ¬¡ç»­å†™${remainingWords}å­—å·¦å³ï¼ˆå…è®¸Â±10%æµ®åŠ¨ï¼‰ã€‚\nå†™åˆ°${remainingWords}å­—é™„è¿‘æ‰¾ä¸ªåˆé€‚çš„åœé¡¿ç‚¹ç»“æŸã€‚\n\nã€å†™ä½œè¦æ±‚ã€‘\n1. ç›´æ¥ç»­å†™ï¼Œç¦æ­¢å¼€åœºç™½ã€è§£é‡Šã€æ€»ç»“ã€markdown\n2. ä¿æŒäººç‰©åç§°ä¸€è‡´ï¼Œä¸è¦æ”¹å‰æ–‡å·²æœ‰çš„äººåç»°å·\n3. ç»†è…»æå†™ï¼Œå¯¹è¯ã€å¿ƒç†ã€åŠ¨ä½œã€ç¯å¢ƒç»“åˆ\n4. æ§åˆ¶èŠ‚å¥ï¼Œä¸è¦ä¸ºäº†å‡‘å­—æ•°è€Œå•°å—¦ï¼Œä¹Ÿä¸è¦ä¸ºäº†çœå­—æ•°è€Œè·³è·ƒ`; let usr = ''; if(prevContext) { usr += `å‰æ–‡å›é¡¾ï¼š\n${prevContext}\n`; } usr += `å½“å‰ç« èŠ‚æ­£æ–‡ï¼š\n${ed.innerText.slice(-500)}\n\nï¼ˆç›´æ¥ç»­å†™ï¼Œä¸è¦é‡å¤ï¼Œä¿æŒäººç‰©åç§°ä¸€è‡´ï¼‰`; const sp = document.createElement('span'); sp.className="typing-cursor"; ed.appendChild(sp); streamAI(usr, sys, document.getElementById('model-select-writer').value, (c)=>{ sp.innerHTML = (sp.innerText + c).replace(/\n/g,'<br>'); document.getElementById('editor-content').scrollTop = document.getElementById('editor-content').scrollHeight; onEditorInput(); }, ()=>{ sp.classList.remove('typing-cursor'); autoSaveContent(); }); }
    function deleteBook(id, e) { e.stopPropagation(); if(confirm("åˆ é™¤ï¼Ÿ")) { appState.books=appState.books.filter(b=>b.id!==id); if(appState.activeBookId==id) appState.activeBookId=null; saveState(); renderBookList(); updateSidebar(); } }
    function deleteVolume(id, e) { e.stopPropagation(); if(confirm("åˆ é™¤ï¼Ÿ")) { const b=getActiveBook(); b.volumes=b.volumes.filter(v=>v.id!==id); if(appState.activeVolumeId==id) appState.activeVolumeId=null; saveState(); renderVolumeList(); updateSidebar(); } }
    function deleteChapter(id, e) { e.stopPropagation(); if(confirm("åˆ é™¤ï¼Ÿ")) { const v=getActiveBook().volumes.find(x=>x.id===appState.activeVolumeId); v.chapters=v.chapters.filter(c=>c.id!==id); if(appState.currentChapterId==id) appState.currentChapterId=null; saveState(); renderChapterList(); updateSidebar(); } }
    
    // æ‰¹é‡åˆ é™¤åŠŸèƒ½
    let batchDeleteMode = false;
    let selectedChapterIds = [];
    function toggleBatchDeleteMode() {
        batchDeleteMode = !batchDeleteMode;
        selectedChapterIds = [];
        document.getElementById('batch-delete-bar').classList.toggle('hidden', !batchDeleteMode);
        document.getElementById('btn-batch-delete').classList.toggle('hidden', batchDeleteMode);
        renderChapterList();
    }
    function cancelBatchDelete() { toggleBatchDeleteMode(); }
    function toggleChapterSelect(id, e) {
        e.stopPropagation();
        if (selectedChapterIds.includes(id)) {
            selectedChapterIds = selectedChapterIds.filter(x => x !== id);
        } else {
            selectedChapterIds.push(id);
        }
        document.getElementById('selected-count').innerText = selectedChapterIds.length;
        renderChapterList();
    }
    function selectAllChapters() {
        const v = getActiveBook().volumes.find(x => x.id === appState.activeVolumeId);
        selectedChapterIds = v.chapters.map(c => c.id);
        document.getElementById('selected-count').innerText = selectedChapterIds.length;
        renderChapterList();
    }
    function confirmBatchDelete() {
        if (selectedChapterIds.length === 0) return alert("è¯·å…ˆé€‰æ‹©ç« èŠ‚");
        if (!confirm(`ç¡®å®šåˆ é™¤ ${selectedChapterIds.length} ç« ï¼Ÿ`)) return;
        const v = getActiveBook().volumes.find(x => x.id === appState.activeVolumeId);
        v.chapters = v.chapters.filter(c => !selectedChapterIds.includes(c.id));
        saveState();
        toggleBatchDeleteMode();
        updateSidebar();
    }
    
    function renderGenres(ctx='create') { document.getElementById(`${ctx}-genre-container`).innerHTML = genres.map(g => `<label class="tag-radio-label"><input type="radio" name="${ctx}-genre" value="${g}" ${g==='ç„å¹»'?'checked':''} class="hidden"> ${g}</label>`).join(''); }
    function initModelSelects() { ['create-title','create-cheat','create-char','create-synopsis','total','volumes','chapters','writer'].forEach(k => fillSelect(`model-select-${k}`)); fillSelect('model-select-edit-generic'); }
    function fillSelect(id) { const e=document.getElementById(id); if(!e)return; e.innerHTML=appState.models.length?'':'<option>è¯·é…ç½®æ¨¡å‹</option>'; appState.models.forEach(m=>{const o=document.createElement('option');o.value=m.id;o.text=m.name;e.appendChild(o)}); }
    function addVolume() { getActiveBook().volumes.push({id:Date.now(), title:'æ–°å·', outline:'', chapters:[]}); saveState(); renderVolumeList(); }
    function addChapter() { getActiveBook().volumes.find(v=>v.id===appState.activeVolumeId).chapters.push({id:Date.now(), title:'æ–°ç« ', outline:'', content:''}); saveState(); renderChapterList(); }
    function saveAndExitEditor() { autoSaveContent(); switchPage('view-volume'); }
    function autoSaveContent() { getActiveBook().volumes.find(v=>v.id===appState.activeVolumeId).chapters.find(c=>c.id===appState.currentChapterId).content = document.getElementById('editor-content').innerHTML; saveState(); }
    function saveCurrentOutline() { getActiveBook().volumes.find(v=>v.id===appState.activeVolumeId).chapters.find(c=>c.id===appState.currentChapterId).outline = document.getElementById('editor-outline-view').value; saveState(); alert("å¤§çº²æ›´æ–°"); }
    function onEditorInput() { autoSaveContent(); document.getElementById('editor-word-count').innerText = countWords(document.getElementById('editor-content').innerText); }
    function copyContent() { navigator.clipboard.writeText(document.getElementById('editor-content').innerText).then(()=>alert("å·²å¤åˆ¶")); }
    function cancelJson() { document.getElementById('json-preview-modal').classList.add('hidden'); }
    function openSettings() { document.getElementById('modal-settings').classList.remove('hidden'); renderModelList(); }
    function closeSettings() { document.getElementById('modal-settings').classList.add('hidden'); initModelSelects(); }
    function renderModelList() { document.getElementById('model-list').innerHTML = appState.models.map(m=>`<div class="bg-white p-3 rounded-lg border border-gray-200 mb-2"><div class="flex justify-between items-center mb-2"><span class="font-bold text-sm">${m.name}</span><div class="flex gap-2"><button onclick="copyModel('${m.id}')" class="text-xs text-orange-500 hover:text-orange-700">å¤åˆ¶</button><button onclick="deleteModel('${m.id}')" class="text-xs text-red-500 hover:text-red-700">åˆ é™¤</button></div></div><div class="grid grid-cols-2 gap-2 text-xs"><input class="border p-1.5 rounded col-span-2" value="${m.name}" onchange="updateModel('${m.id}','name',this.value)" placeholder="åç§°"><input type="password" class="border p-1.5 rounded col-span-2" value="${m.key}" onchange="updateModel('${m.id}','key',this.value)" placeholder="API Key"><input class="border p-1.5 rounded" value="${m.url}" onchange="updateModel('${m.id}','url',this.value)" placeholder="APIåœ°å€"><input class="border p-1.5 rounded" value="${m.modelName}" onchange="updateModel('${m.id}','modelName',this.value)" placeholder="æ¨¡å‹ID"></div></div>`).join(''); }
    function updateModel(id, field, value) { const m = appState.models.find(x=>x.id===id); if(m) { m[field] = value; saveState(); } }
    function copyModel(id) { const m = appState.models.find(x=>x.id===id); if(m) { appState.models.push({id:'m_'+Date.now(), name:m.name+'_copy', key:m.key, url:m.url, modelName:m.modelName}); saveState(); renderModelList(); } }
    function saveModelConfig() { const n=document.getElementById('setting-name').value, k=document.getElementById('setting-key').value, u=document.getElementById('setting-url').value, m=document.getElementById('setting-model').value; if(n&&k){ appState.models.push({id:'m_'+Date.now(), name:n, key:k, url:u||'https://api.openai.com/v1', modelName:m||'gpt-4o-mini'}); saveState(); renderModelList(); document.getElementById('setting-name').value=''; document.getElementById('setting-key').value=''; document.getElementById('setting-url').value=''; document.getElementById('setting-model').value=''; } else { alert('è¯·å¡«å†™åç§°å’ŒAPI Key'); } }
    function deleteModel(id) { if(confirm("åˆ é™¤æ¨¡å‹ï¼Ÿ")) { appState.models=appState.models.filter(m=>m.id!==id); saveState(); renderModelList(); } }
    function exportData() { const blob = new Blob([JSON.stringify(appState)], {type: "application/json"}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `novel_pc_backup_${Date.now()}.json`; a.click(); }
    function triggerImport() { document.getElementById('import-file').click(); }
    function handleFileImport(e) { const r = new FileReader(); r.onload = (ev) => { try { appState = JSON.parse(ev.target.result); saveState(); location.reload(); } catch(err){alert("å¤±è´¥");} }; r.readAsText(e.target.files[0]); }
    function submitCreation() { const title=document.getElementById('create-title').value.trim(); const cheat=document.getElementById('create-cheat').value.trim(); const charInfo=document.getElementById('create-char').value.trim(); const synopsis=document.getElementById('create-synopsis').value.trim(); const sysPrompt=document.getElementById('create-system-prompt').value.trim(); const volCount=document.getElementById('create-total-volumes').value||5; const chPerVol=document.getElementById('create-chapters-per-vol').value||20; if(!title||!synopsis) return alert("è¯·å¡«å†™å®Œæ•´"); const newBook={id:Date.now(), title, cheat, charInfo, synopsis, systemPrompt:sysPrompt, totalVolCount:volCount, chaptersPerVol:chPerVol, genre:document.querySelector('input[name="create-audience"]:checked').value+" "+(document.querySelector('input[name="create-genre"]:checked')?.value||""), audience:document.querySelector('input[name="create-audience"]:checked').value, totalOutline:'', volumes:[]}; appState.books.push(newBook); appState.activeBookId=newBook.id; saveState(); switchPage('view-overview'); }
    function startNewBook() { ['create-title','create-cheat','create-char','create-synopsis','create-system-prompt'].forEach(id=>document.getElementById(id).value=''); switchPage('view-create'); }
</script>
</body>
</html>
